<script lang="ts">
    import {
        ArrowRightIcon,
        CheckIcon,
        DotIcon,
        Icon,
        TriangleAlertIcon,
        ZapIcon,
    } from "@lucide/svelte";
    import { arrowsUpDownSquare } from "@lucide/lab";

    import { nullOf } from "$lib";
    import {
        applyKeys,
        connectKeyboard,
        getKeys,
        isAk680MaxVendorControl,
        LAYERS,
        send,
        setLayerPayload,
        type Keyboard,
    } from "$lib/ak680max";
    import Button from "$lib/components/button.svelte";
    import KeyGrid from "$lib/components/key-grid.svelte";
    import Popup from "$lib/components/popup.svelte";
    import githubLogo from "$lib/assets/github.svg";
    import ToggleButton from "$lib/components/toggle-button.svelte";

    let showDisclaimer = $state(true);
    let showUnsupportedKeyboard = $state(false);
    let showApplyKeysButton = $state(false);
    let showAllActuations = $state(false);
    let keyboard = $state(nullOf<Keyboard>());
    let processingUserLock = $state(false);

    $effect(() => {
        const callback = (event: HIDConnectionEvent) => {
            if (isAk680MaxVendorControl(event.device)) {
                keyboard = null;
            }
        };

        navigator.hid.addEventListener("disconnect", callback);
        return () => {
            if (keyboard) {
                keyboard.device.close();
            }
            navigator.hid.removeEventListener("disconnect", callback);
        };
    });
</script>

{#if !keyboard}
    <div
        class="flex max-w-140 flex-col gap-4 rounded-2xl bg-stone-800 p-8 shadow-md shadow-black/50"
    >
        <h1 class="text-2xl font-bold">Welcome to the Not AJAZZ AK680 MAX Web Utility</h1>
        <p class="mb-6">Connect your not-a-keyboard by pressing the button below</p>
        <Button
            onclick={async () => {
                keyboard = await connectKeyboard();
                if (keyboard.firmwareID !== 2317) {
                    showUnsupportedKeyboard = true;
                }
            }}
        >
            <ZapIcon />Connect
        </Button>
    </div>
{:else}
    <div class="flex max-w-240 flex-col gap-4 p-4">
        <div
            class="flex w-full flex-col gap-2 rounded-2xl bg-stone-800 p-4 shadow-md shadow-black/50"
        >
            <h2 class="text-xl font-bold">AJAZZ AK680 MAX</h2>
            <div class="flex gap-6">
                <p class="text-green-400">Connected</p>
                <p class="opacity-50">ID: {keyboard.firmwareID}</p>
            </div>
        </div>

        <div class="flex flex-col gap-2 rounded-2xl bg-stone-800 p-4 shadow-md shadow-black/50">
            <h2 class="text-lg font-semibold">Layers</h2>
            <div class="flex flex-wrap gap-2">
                {#each LAYERS as layer}
                    <Button
                        onclick={async () => {
                            processingUserLock = true;
                            await send(keyboard!.device, setLayerPayload(layer));
                            keyboard!.activeLayer = layer;

                            setTimeout(async () => {
                                keyboard!.keys = await getKeys(keyboard!.device);
                                processingUserLock = false;
                            }, 500);
                        }}
                        disabled={processingUserLock}
                    >
                        {#if keyboard!.activeLayer === layer}
                            <CheckIcon />
                        {/if}
                        Layer {layer + 1}
                    </Button>
                {/each}
            </div>
        </div>

        <div class="flex flex-col gap-4 rounded-2xl bg-stone-800 p-4 shadow-md shadow-black/50">
            <KeyGrid
                bind:keys={keyboard.keys}
                onActuationChange={() => (showApplyKeysButton = true)}
                {showAllActuations}
            />
            <div class="flex gap-2">
                <Button
                    onclick={async () => {
                        processingUserLock = true;
                        console.debug(keyboard!.keys);
                        await applyKeys(keyboard!);
                        processingUserLock = false;
                    }}
                    disabled={processingUserLock || !showApplyKeysButton}
                    class="flex-1"
                >
                    <CheckIcon />Apply
                </Button>
                <ToggleButton bind:active={showAllActuations}>
                    <Icon iconNode={arrowsUpDownSquare} />
                </ToggleButton>
            </div>
        </div>
    </div>
{/if}

<div class="absolute right-0 bottom-4 left-0 flex items-center justify-center">
    <span class="text-sm opacity-50">
        made with <span class="text-red-600">❤️</span>
        by someever
    </span>
    <DotIcon class="opacity-50" />
    <span class="text-sm opacity-50">not affiliated with or endorsed by ajazz</span>
    <DotIcon class="opacity-50" />
    <a
        href="https://github.com/somenever/not-ajazz-ak680-max-webhid"
        target="_blank"
        rel="noreferrer"
    >
        <img src={githubLogo} alt="GitHub logo" class="h-4 w-4" />
    </a>
</div>

{#if showDisclaimer}
    <Popup modal close={() => (showDisclaimer = false)} class="flex max-w-140 flex-col gap-3 p-6">
        <h2 class="flex flex-col items-center gap-2 text-xl font-bold">
            <TriangleAlertIcon size={48} />
            Disclaimer
        </h2>
        <p class="mb-4">
            This is experimental software. Using it will void any and all warranties from Ajazz
            Electronic Technology Co., Ltd. or any other entity. This software may permanently
            damage your keyboard. By proceeding you assume all risk and agree to hold harmless its
            author, the copyright holder, and any and all other entities.
        </p>
        <Button onclick={() => (showDisclaimer = false)}>
            <CheckIcon />I understand
        </Button>
    </Popup>
{/if}

{#if showUnsupportedKeyboard}
    <Popup
        modal
        close={() => (showUnsupportedKeyboard = false)}
        class="flex max-w-140 flex-col gap-3 p-6"
    >
        <h2 class="flex flex-col items-center gap-2 text-xl font-bold">
            <TriangleAlertIcon size={48} />
            Unsupported Keyboard
        </h2>
        <p class="mb-4">
            This software has only been tested with the AJAZZ AK680 MAX No RGB keyboard (ID 2317).
            Your keyboard (ID {keyboard?.firmwareID ?? "unknown"}) may be different and may not work
            as intended.
        </p>
        <Button onclick={() => (showUnsupportedKeyboard = false)}>
            <ArrowRightIcon />Proceed anyway
        </Button>
    </Popup>
{/if}
